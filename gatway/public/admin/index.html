<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - User Management</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary-color: #667eea;
      --primary-dark: #5a67d8;
      --secondary-color: #764ba2;
      --success-color: #48bb78;
      --warning-color: #ed8936;
      --error-color: #f56565;
      --info-color: #4299e1;
      --text-primary: #2d3748;
      --text-secondary: #718096;
      --text-light: #a0aec0;
      --bg-primary: #f7fafc;
      --bg-secondary: #ffffff;
      --border-color: #e2e8f0;
      --sidebar-width: 280px;
      --header-height: 70px;
      --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
    }

    /* Layout Structure */
    .admin-container {
      display: flex;
      min-height: 100vh;
    }

    /* Sidebar Styles */
    .sidebar {
      width: var(--sidebar-width);
      background: var(--bg-secondary);
      box-shadow: var(--shadow-lg);
      position: fixed;
      left: 0;
      top: 0;
      height: 100vh;
      overflow-y: auto;
      transition: transform 0.3s ease;
      z-index: 1000;
    }

    .sidebar.collapsed {
      transform: translateX(-100%);
    }

    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid var(--border-color);
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
    }

    .sidebar-brand {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 1.25rem;
      font-weight: 700;
    }

    .sidebar-brand i {
      font-size: 1.5rem;
    }

    .sidebar-nav {
      padding: 20px 0;
    }

    .nav-section {
      margin-bottom: 30px;
    }

    .nav-section-title {
      padding: 0 20px 10px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-light);
    }

    .nav-item {
      margin: 2px 10px;
    }

    .nav-link {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 20px;
      color: var(--text-secondary);
      text-decoration: none;
      border-radius: 8px;
      transition: all 0.2s ease;
      font-weight: 500;
      cursor: pointer;
    }

    .nav-link:hover {
      background: var(--bg-primary);
      color: var(--primary-color);
      transform: translateX(4px);
    }

    .nav-link.active {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      color: white;
      box-shadow: var(--shadow-md);
    }

    .nav-link i {
      width: 20px;
      text-align: center;
      font-size: 1.1rem;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      margin-left: var(--sidebar-width);
      transition: margin-left 0.3s ease;
    }

    .main-content.expanded {
      margin-left: 0;
    }

    /* Header */
    .header {
      background: var(--bg-secondary);
      height: var(--header-height);
      box-shadow: var(--shadow-sm);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 30px;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .sidebar-toggle {
      background: none;
      border: none;
      font-size: 1.2rem;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 8px;
      border-radius: 6px;
      transition: all 0.2s ease;
    }

    .sidebar-toggle:hover {
      background: var(--bg-primary);
      color: var(--primary-color);
    }

    .breadcrumb {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .breadcrumb-separator {
      color: var(--text-light);
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .admin-badge {
      background: linear-gradient(135deg, var(--error-color), #ff6b6b);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .user-menu {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 16px;
      background: var(--bg-primary);
      border-radius: 25px;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
    }

    .user-menu:hover {
      background: var(--primary-color);
      color: white;
    }

    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--primary-color);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
    }

    .dropdown {
      position: relative;
    }

    .dropdown-menu {
      position: absolute;
      top: 100%;
      right: 0;
      background: var(--bg-secondary);
      border-radius: 8px;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border-color);
      min-width: 200px;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: all 0.2s ease;
      z-index: 1000;
      margin-top: 8px;
    }

    .dropdown.open .dropdown-menu {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .dropdown-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      color: var(--text-secondary);
      text-decoration: none;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .dropdown-item:hover {
      background: var(--bg-primary);
      color: var(--text-primary);
    }

    .dropdown-divider {
      height: 1px;
      background: var(--border-color);
      margin: 8px 0;
    }

    /* Content Area */
    .content {
      padding: 30px;
    }

    .page-title {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 8px;
      color: var(--text-primary);
    }

    .page-subtitle {
      color: var(--text-secondary);
      margin-bottom: 30px;
    }

    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }

    .stat-card {
      background: var(--bg-secondary);
      padding: 25px;
      border-radius: 12px;
      box-shadow: var(--shadow-sm);
      border-left: 4px solid var(--primary-color);
      transition: all 0.2s ease;
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .stat-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 15px;
    }

    .stat-title {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-icon {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      color: white;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 5px;
    }

    /* Table dStyles */
    .table-container {
      background: var(--bg-secondary);
      border-radius: 12px;
      box-shadow: var(--shadow-sm);
      overflow: hidden;
      margin-bottom: 30px;
    }

    .table-header {
      padding: 20px 25px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .table-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text-primary);
    }

    .table-actions {
      display: flex;
      gap: 10px;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.875rem;
    }

    .btn.primary {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      color: white;
    }

    .btn.primary:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .btn.success {
      background: var(--success-color);
      color: white;
    }

    .btn.warning {
      background: var(--warning-color);
      color: white;
    }

    .btn.danger {
      background: var(--error-color);
      color: white;
    }

    .btn.secondary {
      background: var(--bg-primary);
      color: var(--text-secondary);
      border: 1px solid var(--border-color);
    }

    .btn:hover {
      transform: translateY(-1px);
    }

    .btn.small {
      padding: 4px 8px;
      font-size: 0.75rem;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
    }

    .data-table th,
    .data-table td {
      padding: 15px 25px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }

    .data-table th {
      background: var(--bg-primary);
      font-weight: 600;
      color: var(--text-secondary);
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .data-table tr:hover {
      background: var(--bg-primary);
    }

    /* Status Badges */
    .status-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status-badge.admin {
      background: rgba(245, 101, 101, 0.1);
      color: var(--error-color);
    }

    .status-badge.user {
      background: rgba(72, 187, 120, 0.1);
      color: var(--success-color);
    }

    .status-badge.active {
      background: rgba(72, 187, 120, 0.1);
      color: var(--success-color);
    }

    .status-badge.inactive {
      background: rgba(245, 101, 101, 0.1);
      color: var(--error-color);
    }

    .status-badge.paid {
      background: rgba(72, 187, 120, 0.1);
      color: var(--success-color);
    }

    .status-badge.unpaid {
      background: rgba(237, 137, 54, 0.1);
      color: var(--warning-color);
    }

    /* User Avatar in Table */
    .user-avatar-small {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--primary-color);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 0.875rem;
      margin-right: 10px;
    }

    /* Service Pills */
    .service-pills {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .service-pill {
      background: var(--bg-primary);
      color: var(--text-secondary);
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      border: 1px solid var(--border-color);
    }

    .service-pill.active {
      background: rgba(72, 187, 120, 0.1);
      color: var(--success-color);
      border-color: var(--success-color);
    }

    /* Modal Styles */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: var(--bg-secondary);
      border-radius: 12px;
      box-shadow: var(--shadow-xl);
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      padding: 20px 25px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text-primary);
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      transition: all 0.2s ease;
    }

    .modal-close:hover {
      background: var(--bg-primary);
      color: var(--text-primary);
    }

    .modal-body {
      padding: 25px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: var(--text-primary);
      font-size: 0.875rem;
    }

    .form-input,
    .form-select {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid var(--border-color);
      border-radius: 6px;
      font-size: 0.875rem;
      transition: all 0.2s ease;
      background: var(--bg-primary);
    }

    .form-input:focus,
    .form-select:focus {
      outline: none;
      border-color: var(--primary-color);
      background: var(--bg-secondary);
    }

    .checkbox-group {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      transition: all 0.2s ease;
    }

    .checkbox-item:hover {
      background: var(--bg-primary);
    }

    .checkbox-item input[type="checkbox"] {
      margin: 0;
    }

    /* Search and Filter */
    .search-filter-bar {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .search-input {
      flex: 1;
      min-width: 250px;
      padding: 10px 12px;
      border: 2px solid var(--border-color);
      border-radius: 6px;
      font-size: 0.875rem;
    }

    .filter-select {
      padding: 10px 12px;
      border: 2px solid var(--border-color);
      border-radius: 6px;
      font-size: 0.875rem;
      min-width: 150px;
    }

    /* Alert Messages */
    .alert {
      padding: 12px 16px;
      border-radius: 6px;
      margin-bottom: 20px;
      display: none;
    }

    .alert.success {
      background: rgba(72, 187, 120, 0.1);
      color: var(--success-color);
      border: 1px solid rgba(72, 187, 120, 0.2);
    }

    .alert.error {
      background: rgba(245, 101, 101, 0.1);
      color: var(--error-color);
      border: 1px solid rgba(245, 101, 101, 0.2);
    }

    /* Loading States */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid var(--border-color);
      border-radius: 50%;
      border-top-color: var(--primary-color);
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
      }

      .sidebar.open {
        transform: translateX(0);
      }

      .main-content {
        margin-left: 0;
      }

      .header {
        padding: 0 20px;
      }

      .content {
        padding: 20px;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .data-table {
        font-size: 0.875rem;
      }

      .data-table th,
      .data-table td {
        padding: 10px 15px;
      }

      .search-filter-bar {
        flex-direction: column;
      }

      .search-input {
        min-width: auto;
      }

      .page-title {
        font-size: 1.5rem;
      }

      .user-menu span {
        display: none;
      }

      .admin-badge {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div class="admin-container">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-brand">
          <i class="fas fa-shield-alt"></i>
          <span>Admin Panel</span>
        </div>
      </div>
      
      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">Dashboard</div>
          <div class="nav-item">
            <div class="nav-link active" data-page="overview">
              <i class="fas fa-tachometer-alt"></i>
              <span>Overview</span>
            </div>
          </div>
          <div class="nav-item">
            <div class="nav-link" data-page="users">
              <i class="fas fa-users"></i>
              <span>User Management</span>
            </div>
          </div>
        </div>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content" id="mainContent">
      <!-- Header -->
      <header class="header">
        <div class="header-left">
          <button class="sidebar-toggle" id="sidebarToggle">
            <i class="fas fa-bars"></i>
          </button>
          <div class="breadcrumb">
            <span>Admin Panel</span>
            <span class="breadcrumb-separator">/</span>
            <span id="currentPage">Overview</span>
          </div>
        </div>
        
        <div class="header-right">
          <div class="admin-badge">
            <i class="fas fa-crown"></i>
            Admin
          </div>
          <div class="dropdown">
            <div class="user-menu" id="userMenu">
              <div class="user-avatar" id="userAvatar">A</div>
              <span id="userName">Admin</span>
              <i class="fas fa-chevron-down"></i>
            </div>
            <div class="dropdown-menu" id="userDropdown">
              <div class="dropdown-item">
                <i class="fas fa-user"></i>
                <span>Profile</span>
              </div>
              <div class="dropdown-item">
                <i class="fas fa-cog"></i>
                <span>Settings</span>
              </div>
              <div class="dropdown-divider"></div>
              <div class="dropdown-item" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
              </div>
            </div>
          </div>
        </div>
      </header>

      <!-- Alert Messages -->
      <div class="alert success" id="successAlert"></div>
      <div class="alert error" id="errorAlert"></div>

      <!-- Content -->
      <div class="content">
        <!-- Overview Page -->
        <div id="overviewPage" class="page-content">
          <h1 class="page-title">Admin Dashboard</h1>
          <p class="page-subtitle">Monitor and manage your platform users and services.</p>

          <!-- Stats Grid -->
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-header">
                <div class="stat-title">Total Users</div>
                <div class="stat-icon" style="background: var(--primary-color);">
                  <i class="fas fa-users"></i>
                </div>
              </div>
              <div class="stat-value" id="totalUsers">0</div>
            </div>

            <div class="stat-card">
              <div class="stat-header">
                <div class="stat-title">Admin Users</div>
                <div class="stat-icon" style="background: var(--error-color);">
                  <i class="fas fa-user-shield"></i>
                </div>
              </div>
              <div class="stat-value" id="adminUsers">0</div>
            </div>

            <div class="stat-card">
              <div class="stat-header">
                <div class="stat-title">Active Users</div>
                <div class="stat-icon" style="background: var(--success-color);">
                  <i class="fas fa-user-check"></i>
                </div>
              </div>
              <div class="stat-value" id="activeUsers">0</div>
            </div>

            <div class="stat-card">
              <div class="stat-header">
                <div class="stat-title">API Calls</div>
                <div class="stat-icon" style="background: var(--info-color);">
                  <i class="fas fa-chart-line"></i>
                </div>
              </div>
              <div class="stat-value" id="totalApiCalls">0</div>
            </div>
          </div>
        </div>

        <!-- Users Page -->
        <div id="usersPage" class="page-content" style="display: none;">
          <h1 class="page-title">User Management</h1>
          <p class="page-subtitle">Manage users, their services, and subscription status.</p>

          <!-- Search and Filter Bar -->
          <div class="search-filter-bar">
            <input type="text" class="search-input" id="userSearch" placeholder="Search users by username or email...">
            <select class="filter-select" id="roleFilter">
              <option value="">All Roles</option>
              <option value="admin">Admin</option>
              <option value="user">User</option>
            </select>
            <select class="filter-select" id="statusFilter">
              <option value="">All Status</option>
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
            </select>
            <select class="filter-select" id="subscriptionFilter">
              <option value="">All Subscriptions</option>
              <option value="paid">Paid</option>
              <option value="unpaid">Unpaid</option>
            </select>
            <button class="btn primary" onclick="openAddUserModal()">
              <i class="fas fa-plus"></i>
              Add User
            </button>
          </div>

          <!-- Users Table -->
          <div class="table-container">
            <div class="table-header">
              <h3 class="table-title">All Users</h3>
              <div class="table-actions">
                <button class="btn secondary" onclick="loadUsers()">
                  <i class="fas fa-sync-alt"></i>
                  Refresh
                </button>
                <button class="btn primary" onclick="exportUsers()">
                  <i class="fas fa-download"></i>
                  Export
                </button>
              </div>
            </div>
            <table class="data-table" id="usersTable">
              <thead>
                <tr>
                  <th>User</th>
                  <th>Role</th>
                  <th>Status</th>
                  <th>Subscription</th>
                  <th>Services</th>
                  <th>API Calls</th>
                  <th>Last IP</th>
                  <th>Created</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="usersTableBody">
                <!-- Users will be loaded here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Add User Modal -->
  <div class="modal" id="addUserModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Add New User</h3>
        <button class="modal-close" onclick="closeModal('addUserModal')">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <form id="addUserForm">
          <div class="form-group">
            <label class="form-label">Username</label>
            <input type="text" class="form-input" name="username" required>
          </div>
          <div class="form-group">
            <label class="form-label">Email</label>
            <input type="email" class="form-input" name="email" required>
          </div>
          <div class="form-group">
            <label class="form-label">Password</label>
            <input type="password" class="form-input" name="password" required>
          </div>
          <div class="form-group">
            <label class="form-label">Role</label>
            <select class="form-select" name="role">
              <option value="user">User</option>
              <option value="admin">Admin</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Status</label>
            <select class="form-select" name="status">
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Subscription</label>
            <select class="form-select" name="subscription">
              <option value="unpaid">Unpaid</option>
              <option value="paid">Paid</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Available Services</label>
            <div class="checkbox-group" id="servicesCheckboxes">
              <!-- Service checkboxes will be loaded here -->
            </div>
          </div>
          <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
            <button type="button" class="btn secondary" onclick="closeModal('addUserModal')">Cancel</button>
            <button type="submit" class="btn primary">
              <i class="fas fa-plus"></i>
              Add User
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Edit User Modal -->
  <div class="modal" id="editUserModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Edit User</h3>
        <button class="modal-close" onclick="closeModal('editUserModal')">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <form id="editUserForm">
          <input type="hidden" name="userId" id="editUserId">
          <div class="form-group">
            <label class="form-label">Username</label>
            <input type="text" class="form-input" name="username" id="editUsername" required>
          </div>
          <div class="form-group">
            <label class="form-label">Email</label>
            <input type="email" class="form-input" name="email" id="editEmail" required>
          </div>
          <div class="form-group">
            <label class="form-label">Role</label>
            <select class="form-select" name="role" id="editRole">
              <option value="user">User</option>
              <option value="admin">Admin</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Status</label>
            <select class="form-select" name="status" id="editStatus">
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Subscription</label>
            <select class="form-select" name="subscription" id="editSubscription">
              <option value="unpaid">Unpaid</option>
              <option value="paid">Paid</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Available Services</label>
            <div class="checkbox-group" id="editServicesCheckboxes">
              <!-- Service checkboxes will be loaded here -->
            </div>
          </div>
          <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
            <button type="button" class="btn secondary" onclick="closeModal('editUserModal')">Cancel</button>
            <button type="submit" class="btn primary">
              <i class="fas fa-save"></i>
              Save Changes
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Change Password Modal -->
  <div class="modal" id="changePasswordModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Change Password</h3>
        <button class="modal-close" onclick="closeModal('changePasswordModal')">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <form id="changePasswordForm">
          <input type="hidden" name="userId" id="passwordUserId">
          <div class="form-group">
            <label class="form-label">New Password</label>
            <input type="password" class="form-input" name="password" required>
          </div>
          <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
            <button type="button" class="btn secondary" onclick="closeModal('changePasswordModal')">Cancel</button>
            <button type="submit" class="btn primary">
              <i class="fas fa-key"></i>
              Change Password
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    // Global variables
    let users = [];
    let currentUser = null;
    const API_BASE = '/api/admin';
    const AUTH_BASE = '/api/auth';

    // Available services
    const availableServices = [
      { id: 'payment-gateway', name: 'Payment Gateway', icon: 'fas fa-credit-card' },
      { id: 'whatsapp-api', name: 'WhatsApp API', icon: 'fab fa-whatsapp' },
      { id: 'otp-service', name: 'OTP Service', icon: 'fas fa-shield-alt' },
      { id: 'email-api', name: 'Email API', icon: 'fas fa-envelope' },
      { id: 'sms-gateway', name: 'SMS Gateway', icon: 'fas fa-sms' },
      { id: 'file-storage', name: 'File Storage', icon: 'fas fa-cloud-upload-alt' },
      { id: 'analytics', name: 'Analytics API', icon: 'fas fa-chart-bar' },
      { id: 'notifications', name: 'Push Notifications', icon: 'fas fa-bell' }
    ];

    // Initialize admin panel
    document.addEventListener('DOMContentLoaded', function() {
      // checkAuth();
      initializeAdminPanel();
      loadUsers();
      loadStats();
      setupEventListeners();
    });

    // function checkAuth() {
    //   const token = localStorage.getItem('adminToken');
    //   const user = JSON.parse(localStorage.getItem('adminUser') || '{}');
      
    //   if (!token || !user.role || user.role !== 'admin') {
    //     window.location.href = '/login';
    //     return;
    //   }

    //   currentUser = user;
      
    //   // Update user info in header
    //   document.getElementById('userName').textContent = user.username;
    //   document.getElementById('userAvatar').textContent = user.username.charAt(0).toUpperCase();
    // }

    function getAuthHeaders() {
      const token = localStorage.getItem('adminToken');
      return {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      };
    }

    async function apiRequest(url, options = {}) {
      const response = await fetch(url, {
        ...options,
        headers: {
          ...getAuthHeaders(),
          ...options.headers
        }
      });

      if (response.status === 401) {
        localStorage.removeItem('adminToken');
        localStorage.removeItem('adminUser');
        window.location.href = '/auth.html';
        return;
      }

      return response;
    }

    function initializeAdminPanel() {
      // Set up sidebar toggle
      const sidebarToggle = document.getElementById('sidebarToggle');
      const sidebar = document.getElementById('sidebar');
      const mainContent = document.getElementById('mainContent');

      sidebarToggle.addEventListener('click', function() {
        sidebar.classList.toggle('open');
        mainContent.classList.toggle('expanded');
      });

      // Set up navigation
      const navLinks = document.querySelectorAll('.nav-link');
      navLinks.forEach(link => {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          const page = this.getAttribute('data-page');
          navigateToPage(page);
        });
      });

      // Set up user dropdown
      const userMenu = document.getElementById('userMenu');
      const userDropdown = document.getElementById('userDropdown');
      
      userMenu.addEventListener('click', function() {
        userMenu.parentElement.classList.toggle('open');
      });

      // Close dropdown when clicking outside
      document.addEventListener('click', function(e) {
        if (!userMenu.contains(e.target)) {
          userMenu.parentElement.classList.remove('open');
        }
      });

      // Load service checkboxes
      loadServiceCheckboxes();
    }

    function setupEventListeners() {
      // Search functionality
      document.getElementById('userSearch').addEventListener('input', filterUsers);
      document.getElementById('roleFilter').addEventListener('change', filterUsers);
      document.getElementById('statusFilter').addEventListener('change', filterUsers);
      document.getElementById('subscriptionFilter').addEventListener('change', filterUsers);

      // Form submissions
      document.getElementById('addUserForm').addEventListener('submit', handleAddUser);
      document.getElementById('editUserForm').addEventListener('submit', handleEditUser);
      document.getElementById('changePasswordForm').addEventListener('submit', handleChangePassword);

      // Close sidebar on mobile when clicking outside
      document.addEventListener('click', function(e) {
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebarToggle');
        
        if (window.innerWidth <= 768 && 
            !sidebar.contains(e.target) && 
            !sidebarToggle.contains(e.target) &&
            sidebar.classList.contains('open')) {
          sidebar.classList.remove('open');
        }
      });
    }

    function navigateToPage(page) {
      
      // Update active nav link
      document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
      });
      document.querySelector(`[data-page="${page}"]`).classList.add('active');

      // Update breadcrumb
      document.getElementById('currentPage').textContent = 
        page.charAt(0).toUpperCase() + page.slice(1);

      // Show/hide page content
      document.querySelectorAll('.page-content').forEach(content => {
        content.style.display = 'none';
      });
      
      const targetPage = document.getElementById(`${page}Page`);
      if (targetPage) {
        targetPage.style.display = 'block';
      }

      // Close sidebar on mobile after navigation
      if (window.innerWidth <= 768) {
        document.getElementById('sidebar').classList.remove('open');
      }
    }

    async function loadUsers() {
      try {
        const response = await apiRequest(`${API_BASE}/users`);
        if (!response.ok) throw new Error('Failed to load users');
        
        const data = await response.json();
        users = data.users || data; // Handle both paginated and simple array responses
        renderUsersTable();
      } catch (error) {
        showAlert('error', 'Failed to load users: ' + error.message);
      }
    }

    async function loadStats() {
      try {
        const response = await apiRequest(`${API_BASE}/stats`);
        if (!response.ok) throw new Error('Failed to load stats');
        
        const stats = await response.json();
        updateStatsDisplay(stats);
      } catch (error) {
        console.error('Failed to load stats:', error);
        // Fallback to calculating from users data
        calculateStatsFromUsers();
      }
    }

    function updateStatsDisplay(stats) {
      document.getElementById('totalUsers').textContent = stats.totalUsers || 0;
      document.getElementById('adminUsers').textContent = stats.adminUsers || 0;
      document.getElementById('activeUsers').textContent = stats.activeUsers || 0;
      document.getElementById('totalApiCalls').textContent = (stats.totalApiCalls || 0).toLocaleString();
    }

    function calculateStatsFromUsers() {
      const totalUsers = users.length;
      const adminUsers = users.filter(u => u.role === 'admin').length;
      const activeUsers = users.filter(u => u.status === 'active').length;
      const totalApiCalls = users.reduce((sum, u) => sum + (u.apiCalls || 0), 0);

      updateStatsDisplay({
        totalUsers,
        adminUsers,
        activeUsers,
        totalApiCalls
      });
    }

    function renderUsersTable() {
      const tbody = document.getElementById('usersTableBody');
      tbody.innerHTML = '';

      users.forEach(user => {
        const row = createUserRow(user);
        tbody.appendChild(row);
      });
    }

    function createUserRow(user) {
      const row = document.createElement('tr');
      
      // User info
      const userCell = document.createElement('td');
      userCell.innerHTML = `
        <div style="display: flex; align-items: center;">
          <div class="user-avatar-small">${user.username ? user.username.charAt(0).toUpperCase()  : '?'}</div>
          <div>           <div style="font-weight: 600;">${user.username}</div>
            <div style="font-size: 0.75rem; color: var(--text-secondary);">${user.email || 'No email'}</div>
          </div>
        </div>
      `;

      // Role
      const roleCell = document.createElement('td');
      roleCell.innerHTML = `<span class="status-badge ${user.role}">${user.role}</span>`;

      // Status
      const statusCell = document.createElement('td');
      statusCell.innerHTML = `<span class="status-badge ${user.status || 'active'}">${user.status || 'active'}</span>`;

      // Subscription
      const subscriptionCell = document.createElement('td');
      subscriptionCell.innerHTML = `<span class="status-badge ${user.subscription || 'unpaid'}">${user.subscription || 'unpaid'}</span>`;

      // Services
      const servicesCell = document.createElement('td');
      const servicePills = (user.services || []).map(serviceId => {
        const service = availableServices.find(s => s.id === serviceId);
        return `<span class="service-pill active">${service ? service.name : serviceId}</span>`;
      }).join('');
      servicesCell.innerHTML = `<div class="service-pills">${servicePills || '<span class="service-pill">None</span>'}</div>`;

      // API Calls
      const apiCallsCell = document.createElement('td');
      apiCallsCell.textContent = (user.apiCalls || 0).toLocaleString();

      // Last IP
      const ipCell = document.createElement('td');
      ipCell.innerHTML = `<code style="background: var(--bg-primary); padding: 2px 6px; border-radius: 4px; font-size: 0.75rem;">${user.lastIP || '0.0.0.0'}</code>`;

      // Created date
      const createdCell = document.createElement('td');
      const createdDate = new Date(user.createdAt || Date.now());
      createdCell.innerHTML = `
        <div>${createdDate.toLocaleDateString()}</div>
        <div style="font-size: 0.75rem; color: var(--text-secondary);">${createdDate.toLocaleTimeString()}</div>
      `;

      // Actions
      const actionsCell = document.createElement('td');
      actionsCell.innerHTML = `
        <div style="display: flex; gap: 5px;">
          <button class="btn small primary" onclick="editUser('${user._id}')">
            <i class="fas fa-edit"></i>
          </button>
          <button class="btn small warning" onclick="changePassword('${user._id}')">
            <i class="fas fa-key"></i>
          </button>
          <button class="btn small danger" onclick="deleteUser('${user._id}')">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      `;

      row.appendChild(userCell);
      row.appendChild(roleCell);
      row.appendChild(statusCell);
      row.appendChild(subscriptionCell);
      row.appendChild(servicesCell);
      row.appendChild(apiCallsCell);
      row.appendChild(ipCell);
      row.appendChild(createdCell);
      row.appendChild(actionsCell);

      return row;
    }

    function loadServiceCheckboxes() {
      const addContainer = document.getElementById('servicesCheckboxes');
      const editContainer = document.getElementById('editServicesCheckboxes');
      
      availableServices.forEach(service => {
        // Add user modal
        const addCheckbox = document.createElement('div');
        addCheckbox.className = 'checkbox-item';
        addCheckbox.innerHTML = `
          <input type="checkbox" id="add_${service.id}" name="services" value="${service.id}">
          <label for="add_${service.id}">
            <i class="${service.icon}"></i>
            ${service.name}
          </label>
        `;
        addContainer.appendChild(addCheckbox);

        // Edit user modal
        const editCheckbox = document.createElement('div');
        editCheckbox.className = 'checkbox-item';
        editCheckbox.innerHTML = `
          <input type="checkbox" id="edit_${service.id}" name="services" value="${service.id}">
          <label for="edit_${service.id}">
            <i class="${service.icon}"></i>
            ${service.name}
          </label>
        `;
        editContainer.appendChild(editCheckbox);
      });
    }

    function filterUsers() {
      const searchTerm = document.getElementById('userSearch').value.toLowerCase();
      const roleFilter = document.getElementById('roleFilter').value;
      const statusFilter = document.getElementById('statusFilter').value;
      const subscriptionFilter = document.getElementById('subscriptionFilter').value;

      const filteredUsers = users.filter(user => {
        const matchesSearch = user.username.toLowerCase().includes(searchTerm) ||
                            (user.email && user.email.toLowerCase().includes(searchTerm));
        const matchesRole = !roleFilter || user.role === roleFilter;
        const matchesStatus = !statusFilter || user.status === statusFilter;
        const matchesSubscription = !subscriptionFilter || user.subscription === subscriptionFilter;

        return matchesSearch && matchesRole && matchesStatus && matchesSubscription;
      });

      // Re-render table with filtered users
      const tbody = document.getElementById('usersTableBody');
      tbody.innerHTML = '';
      filteredUsers.forEach(user => {
        const row = createUserRow(user);
        tbody.appendChild(row);
      });
    }

    function openAddUserModal() {
      document.getElementById('addUserModal').classList.add('show');
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('show');
    }

    function editUser(userId) {
      const user = users.find(u => u._id === userId);
      if (!user) return;

      // Populate edit form
      document.getElementById('editUserId').value = user._id;
      document.getElementById('editUsername').value = user.username;
      document.getElementById('editEmail').value = user.email || '';
      document.getElementById('editRole').value = user.role;
      document.getElementById('editStatus').value = user.status || 'active';
      document.getElementById('editSubscription').value = user.subscription || 'unpaid';

      // Check user's services
      availableServices.forEach(service => {
        const checkbox = document.getElementById(`edit_${service.id}`);
        checkbox.checked = (user.services || []).includes(service.id);
      });

      document.getElementById('editUserModal').classList.add('show');
    }

    function changePassword(userId) {
      document.getElementById('passwordUserId').value = userId;
      document.getElementById('changePasswordModal').classList.add('show');
    }

    async function deleteUser(userId) {
      if (!confirm('Are you sure you want to delete this user?')) return;

      try {
        const response = await apiRequest(`${API_BASE}/users/${userId}`, {
          method: 'DELETE',
           credentials: 'include'
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to delete user');
        }

        showAlert('success', 'User deleted successfully');
        loadUsers();
        loadStats();
      } catch (error) {
        showAlert('error', 'Failed to delete user: ' + error.message);
      }
    }

    async function handleAddUser(e) {
      e.preventDefault();
      const formData = new FormData(e.target);
      
      const userData = {
        username: formData.get('username'),
        email: formData.get('email'),
        password: formData.get('password'),
        role: formData.get('role'),
        status: formData.get('status'),
        subscription: formData.get('subscription'),
        services: formData.getAll('services')
      };

      try {
        const response = await apiRequest(`${API_BASE}/users`, {
          method: 'POST',
           credentials: 'include',
          body: JSON.stringify(userData)
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to create user');
        }

        showAlert('success', 'User created successfully');
        closeModal('addUserModal');
        e.target.reset();
        
        // Uncheck all service checkboxes
        availableServices.forEach(service => {
          document.getElementById(`add_${service.id}`).checked = false;
        });
        
        loadUsers();
        loadStats();
      } catch (error) {
        showAlert('error', 'Failed to create user: ' + error.message);
      }
    }

    async function handleEditUser(e) {
      e.preventDefault();
      const formData = new FormData(e.target);
      const userId = formData.get('userId');
      
      const userData = {
        username: formData.get('username'),
        email: formData.get('email'),
        role: formData.get('role'),
        status: formData.get('status'),
        subscription: formData.get('subscription'),
        services: formData.getAll('services')
      };

      try {
        const response = await apiRequest(`${API_BASE}/users/${userId}`, {
          method: 'PUT',
           credentials: 'include',
          body: JSON.stringify(userData)
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to update user');
        }

        showAlert('success', 'User updated successfully');
        closeModal('editUserModal');
        loadUsers();
        loadStats();
      } catch (error) {
        showAlert('error', 'Failed to update user: ' + error.message);
      }
    }

    async function handleChangePassword(e) {
      e.preventDefault();
      const formData = new FormData(e.target);
      const userId = formData.get('userId');
      
      const passwordData = {
        password: formData.get('password')
      };

      try {
        const response = await apiRequest(`${API_BASE}/users/${userId}/password`, {
          method: 'PUT',
           credentials: 'include',
          body: JSON.stringify(passwordData)
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to change password');
        }

        showAlert('success', 'Password changed successfully');
        closeModal('changePasswordModal');
        e.target.reset();
      } catch (error) {
        showAlert('error', 'Failed to change password: ' + error.message);
      }
    }

    async function exportUsers() {
      try {
        const response = await apiRequest(`${API_BASE}/export/users`);
        if (!response.ok) throw new Error('Failed to export users');

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `users_export_${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        window.URL.revokeObjectURL(url);
      } catch (error) {
        showAlert('error', 'Failed to export users: ' + error.message);
      }
    }

      async function fetchUserInfo() {

    

    try {
      const res = await fetch('/api/user/me', {
        method: 'GET',
        credentials: 'include' 
      });

      if (!res.ok) {
        throw new Error('Not authorized');
      }

      const user = await res.json();
    //   document.getElementById('username').textContent = user.username;
    //   document.getElementById('role').textContent = user.role;
    } catch (err) {
      console.error('Failed to fetch user:', err);
      alert('Session expired. Please login again.');
      window.location.href = '/auth';
    }
  }


   async function logout() {
  if (confirm('Are you sure you want to logout?')) {
    await fetch('/auth/logout', {
      method: 'POST',
      credentials: 'include' // 🔑 send cookie
    });

    window.location.href = '/auth';
  }
}


async function logout() {
  if (confirm('Are you sure you want to logout?')) {
    await fetch('/auth/logout', {
      method: 'POST',
      credentials: 'include' // 🔑 send cookie
    });

    window.location.href = '/auth';
  }
}


    function showAlert(type, message) {
      const alertElement = document.getElementById(type + 'Alert');
      alertElement.textContent = message;
      alertElement.style.display = 'block';
      
      setTimeout(() => {
        alertElement.style.display = 'none';
      }, 5000);
    }

    // Close modals when clicking outside
    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('modal')) {
        e.target.classList.remove('show');
      }
    });
fetchUserInfo();
    // Auto-refresh stats every 30 seconds
    setInterval(() => {
      loadStats();
    }, 30000);
  </script>

/







</body>
</html>
